{% if Entity.Users.userData.chem_editor %}
    <link rel='stylesheet' href='app/css/chemdoodle.css' type='text/css'>
    <script src='app/js/chemdoodle/chemdoodle.min.js'></script>
{% endif %}
<script src='app/js/tinymce-dropzone.min.js'></script>

{# back to link #}
<a href='?mode=show'>
    <img src='app/img/arrow-left-blue.png' alt='' />{{ 'Back to %s listing'|format(Entity.page) }}
</a>

{% if Entity.entityData.userid != Entity.Users.userid and Entity.type == 'experiments' %}
    {{ 'Experiment of %s'|trans|format(Entity.fullname)|msg('ok', false) }}
{% endif %}

<section class='box' id='main_section' style='border-left: 6px solid #{{ Entity.entityData.color }}'>
    <img class='align_right entityDestroy' src='app/img/big-trash.png' title='delete' alt='delete' data-type='{{ Entity.type }}' data-id='{{ Entity.id }}' data-confirm="{{ 'Delete this?'|trans }}" />

    <!-- TAGS -->
    <img src='app/img/tags.png' alt='tags' /><label for='addtaginput'>{{ 'Tags'|trans }}</label>
    <div class='tags'>
        <span id='tags_div'>
            <!--  build the tag array -->
            {% if Entity.entityData.tags|length > 0 %}
                {% set tagsIdArr = Entity.entityData.tags_id|split(',') %}
                {% set tagsValueArr = Entity.entityData.tags|split('|') %}
                {% for key, tag in tagsValueArr %}
                    {# the key allows to get the id stored in tagsIdArr #}
                    <span class='tag'>
                        <a class='tagDestroy' data-type='{{ Entity.type }}' data-id='{{ Entity.id }}' data-tagid='{{ tagsIdArr[key] }}' data-confirm="{{ 'Delete this?'|trans }}">
                            {{ tag|raw }}
                        </a>
                    </span>
                {% endfor %}
            {% endif %}
        </span>
        <input type='text' id='createTagInput' placeholder='{{ 'Add a tag'|trans }}' />
    </div>

    <!--  MAIN FORM -->
    <form id='main_form' method='post' action='app/controllers/EntityController.php' enctype='multipart/form-data'>
        <input name='update' type='hidden' value='true' />
        <input name='id' type='hidden' value='{{ Entity.id }}' />
        <input name='type' type='hidden' value='{{ Entity.type }}' />

        <!-- DATE -->
            <div class='row'>
                <div class='col-md-4'>
                    <img src='app/img/calendar.png' title='date' alt='calendar' />
                    <label for='datepicker'>{{ 'Date'|trans }}</label>
                    <!-- if firefox has support for it: type = date -->
                    <!-- https://bugzilla.mozilla.org/show_bug.cgi?id=825294 -->
                    <input name='date' id='datepicker' size='8' type='text' value='{{ Entity.entityData.date }}' />
                </div>

            {% if Entity.type == 'experiments' %}
                <!-- VISIBILITY -->
                <div class='col-md-4'>
                    <img src='app/img/eye.png' alt='visibility' />
                    <label for='visibility_select'>{{ 'Visibility'|trans }}</label>
                    <select id='visibility_select'>
                        {% for key, value in TeamGroups.getVisibilityList %}
                            <option value='{{ key }}'
                            {{ Entity.entityData.visibility == key ? ' selected' }}
                            >{{ value|trans }}</option>
                        {% endfor %}
                    </select>
                </div>
            {% endif %}

                <!-- CATEGORIES (status for exp and itemstypes for items) -->
                <div class='col-md-4'>
                    <img src='app/img/status.png' alt='category' />
                    <label for='category_select'>
                    {% if Entity.type == 'experiments' %}
                    {{ 'Status'|trans }}
                    {% else %}
                    {{ 'Category'|trans }}
                    {% endif %}
                    </label>
                    <select id='category_select'>
                        {% for category in Categories.readAll %}
                            <option value='{{ category.category_id }}'
                            {{ Entity.entityData.category_id == category.category_id ? ' selected' }}>{{ category.category }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% if Entity.type == 'items' %}
                    <!-- STAR RATING -->
                    <div class='col-md-4' style='margin-top:15px'>
                        {% for i in range(1, 5) %}
                        <input data-rating='{{ i }}' name='star' type='radio' class='star' value='{{ i }}' {{ Entity.entityData.rating == i ? ' checked=checked' }} />
                        {% endfor %}
                    </div>
                {% endif %}

            </div>
            <!-- TITLE -->
            <h4>{{ 'Title'|trans }}</h4>
            <input id='title_input' name='title' rows='1' value='{{ Entity.entityData.title|raw }}' required />

            <!-- BODY -->
            {% if Entity.type == 'experiments' %}
                <h4>{{ 'Experiment'|trans }}</h4>
            {% else %}
                <h4>{{ 'Infos'|trans }}</h4>
            {% endif %}

            <textarea id='body_area' class='{{ not Entity.Users.userData.use_markdown ? 'mceditable' }}' name='body' rows='15' cols='80'>{{ Entity.entityData.body|raw }}</textarea>

            <div class='submitButtonDiv'>
                <button type='submit' name='Submit' class='button'>{{ 'Save and go back'|trans }}</button>
            </div>
        </form>

    <!-- REVISIONS -->
    {{ Revisions.showCount|raw }}

    {% if Entity.type == 'experiments' %}
        <!-- STEPS -->
        <section>
            <img src='app/img/step.png' alt='steps' /> <h4 style='display:inline'>{{ 'Experiments steps'|trans }}</h4>
            <br>
            <div class='list' id='steps_div'>
                {% set stepsArr = Entity.Steps.read %}
                {% if stepsArr|length > 0 %}
                <ul class='list-group'>
                    {% for step in stepsArr %}
                    <li class='list-group-item {{ step.finished ? 'finished' }}'>
                        <input type='checkbox' {{ step.finished ? 'checked=checked' }} data-stepid='{{ step.id }}' /> {{ step.body|raw }}
                        <span class='align_right'>{{ step.finished ? step.finished_time }}
                        <a class='stepDestroy' data-stepid='{{ step.id }}'>
                        <img src='app/img/small-trash.png' title='Delete' alt='Delete' /></a></span>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            <p class='inline'>{{ 'Add a step'|trans }}</p>
            <input id='stepinput' size='60' type='text' name='step' />
        </section>
        <!-- LINKS -->
        <section>
            <img src='app/img/link.png' alt='link' /> <h4 style='display:inline'>{{ 'Linked items'|trans }}</h4>
            <br>
            <div class='list' id='links_div'>
                {% set linksArr = Entity.Links.readAll %}
                {% if linksArr %}
                <ul class='list-group'>
                    {% for link in linksArr %}
                    <li class='list-group-item'>{{ link.name|raw }} - <a href='database.php?mode=view&id={{ link.itemid }}'>
                            {{ link.title|raw }}</a>
                        <a class='linkDestroy' data-linkid='{{ link.linkid }}'>
                        <img class='align_right' src='app/img/small-trash.png' title='Delete' alt='Delete' /></a>
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}
            </div>
            <p class='inline'>{{ 'Add a link'|trans }}</p>
            <input id='linkinput' size='60' type='text' name='link' placeholder='{{ 'from the database'|trans }}' />
        </section>
    {% endif %}
</section>

<!-- UPLOAD FORM -->
<section class='box'>
    <img src='app/img/attached.png' />
    <h3 style='display:inline'>{{ 'Attach a file'|trans }}</h3>
    <form action='app/controllers/EntityController.php' class='dropzone' id='elabftw-dropzone'></form>
</section>

<script>
// config for dropzone, id is camelCased.
Dropzone.options.elabftwDropzone = {
    // i18n message to user
    dictDefaultMessage: '{{ 'Drop files here to upload'|trans }}',
    maxFilesize: '{{ maxUploadSize }}', // MB
    init: function() {

        // add additionnal parameters (id and type)
        this.on('sending', function(file, xhr, formData) {
            formData.append('upload', true);
            formData.append('id', '{{ Uv.Uploads.Entity.id }}');
            formData.append('type', '{{ Uv.Uploads.Entity.type }}');
        });

        // once it is done
        this.on('complete', function(answer) {
            // check the answer we get back from app/controllers/EntityController.php
            var json = JSON.parse(answer.xhr.responseText);
            if (json.res) {
                notif(json.msg, 'ok');
            } else {
                notif(json.msg, 'ko');
            }
            // reload the #filesdiv once the file is uploaded
            if (this.getUploadingFiles().length === 0 && this.getQueuedFiles().length === 0) {
                $('#filesdiv').load('?mode=edit&id={{ Uv.Uploads.Entity.id }} #filesdiv', function() {
                    // make the comment zone editable (fix issue #54)
                    makeEditableFileComment('{{ Uv.Uploads.Entity.type }}', {{ Uv.Uploads.Entity.id }});
                });
            }
        });
    }
}
</script>

{{ include('uploads.html') }}

<!-- DOODLE -->
<section class='box'>
    <img src='app/img/pencil.png' />
    <h3 class='inline'>{{ 'Draw something'|trans }}</h3>
    <button class='button' id='show_doodle_canvas'>{{ 'Show canvas'|trans }}</button>
    <div class='canvasDiv'>
        <canvas class='doodle' id='doodleCanvas' width='700px' height='600px'></canvas>
        <button class='button button-delete clearCanvas'>{{ 'Clear'|trans }}</button>
        <button class='button saveCanvas' data-type='{{ Entity.type }}' data-id='{{ Entity.id }}'>{{ 'Save'|trans }}</button>
    </div>
</section>
<script src='app/js/doodle.js'></script>

<!-- CHEM EDITOR -->
{% if Entity.Users.userData.chem_editor %}
    <div class='box chemdoodle'>
        <img src='app/img/atom.png' />
        <h3 class='inline'>{{ 'Molecule drawer'|trans }}</h3>
        <button class='button' id='show_chem_editor'>{{ 'Show editor'|trans }}</button>
        <div class='center' style='display:none' id='chem_editor'>
            <script src='app/js/sketcher.js'></script>
        </div>
    </div>
{% endif %}

{% if Entity.Users.userData.close_warning %}
    <script src='app/js/closeWarning.js'></script>
{% endif %}
<div id='entityInfos'
    data-type='{{ Entity.type }}'
    data-id='{{ Entity.id }}'
    data-title='{{ cleanTitle }}'
    data-confirm="{{ 'Delete this?'|trans }}"
    data-untitled="{{ 'Untitled'|trans }}"
    data-lang="{{ Entity.Users.userData.lang }}">
</div>
<div id='shortcuts'
    data-create='{{ Entity.Users.userData.sc_create }}'
    data-submit='{{ Entity.Users.userData.sc_submit }}'>
</div>
<script src='app/js/edit.js'></script>
